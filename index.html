<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Evalutation Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .container {
            max-width: 1000px;
        }
        .card {
            background-color: #161b22; /* Slightly lighter card background */
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .btn {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .mcq-answer-correct {
            color: #38a169; /* Green text for correct answer */
            font-weight: 600;
        }
        .pulse-animation {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .skeleton-line {
            background-color: #30363d;
            height: 1.5rem;
            border-radius: 0.25rem;
            animation: loading-pulse 1.5s infinite;
        }
        @keyframes loading-pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .result-correct {
            border-left: 4px solid #38a169;
        }
        .result-incorrect {
            border-left: 4px solid #e53e3e;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-200" oncontextmenu="return false;">

    <div class="container mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-green-400 border-b border-gray-700 pb-3">Skill Evalutation Tool</h1>

        <!-- API Key Setup (Reintroduced) -->
        <div class="card p-6 rounded-lg mb-8" id="apiKeySetup">
            <h2 class="text-xl font-semibold mb-4 text-green-300">1. API Key Setup</h2>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <input type="text" id="userId" value="Auto-Generated User" disabled class="p-3 rounded-lg flex-grow bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                <button id="authBtn" class="btn bg-green-700 text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50" disabled>
                    Auto-Authenticated
                </button>
            </div>
            <div id="apiKeyDisplay" class="mt-4 p-3 bg-gray-800 rounded-lg text-sm break-all">
                API Key: <span id="apiKeyStatus" class="text-yellow-400">Loading Key...</span>
            </div>
            <div id="statusMessage" class="mt-3 text-sm text-red-400 hidden"></div>
        </div>

        <!-- Domain Selection and Fetch -->
        <div class="card p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-green-300">2. Select Quiz Parameters</h2>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
                <select id="domainSelect" class="p-3 rounded-lg flex-grow bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" disabled>
                    <option value="">-- Select Domain --</option>
                    <!-- Options populated by JS -->
                </select>
                <select id="categorySelect" class="p-3 rounded-lg flex-grow bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" disabled>
                    <option value="">-- Select Difficulty --</option>
                    <!-- Options populated by JS -->
                </select>
                <button onclick="loadQuestions()" id="loadQuestionsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50" disabled>
                    Load Quiz
                </button>
            </div>
            <!-- Status message area -->
            <div id="domainOverview" class="mt-4 p-3 bg-gray-800 rounded-lg text-sm">
                Authenticating and loading domains...
            </div>
        </div>

        <!-- Quiz Area -->
        <form id="quizForm" class="card p-6 rounded-lg hidden">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h2 class="text-2xl font-semibold text-green-300">3. Active : <span id="quizTitle"></span></h2>
                <span class="text-xl font-bold text-gray-400">Total : <span id="quizTotalQs"></span></span>
            </div>
            
            <div id="questionContainer" class="space-y-6">
                <!-- Questions populated here -->
            </div>

            <button type="button" onclick="submitQuiz()" id="submitQuizBtn" class="mt-8 w-full btn bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg">
                Submit and View Score
            </button>
        </form>

        <!-- Results Area -->
        <div id="resultsContainer" class="card p-6 rounded-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-yellow-400 mb-4 border-b border-gray-700 pb-3">Quiz Results</h2>
            <div id="scoreSummary" class="text-lg font-bold mb-4"></div>
            <button onclick="window.location.reload()" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">
                Start New 
            </button>
            <div id="resultsDetails" class="space-y-6 mt-6">
                <!-- Detailed results populated here -->
            </div>
        </div>

    </div>

    <script>
        // Set the API URL to your live Render deployment
        const API_BASE_URL = 'https://fast-quiz-api.onrender.com';
        
        let API_KEY = ''; // Automatically generated on init
        let currentDomains = {};
        let activeQuestions = [];
        let activeQuizType = "";
        const MAX_QUESTIONS = { easy: 20, medium: 10, hard: 5 };

        const elements = {
            userId: document.getElementById('userId'),
            authBtn: document.getElementById('authBtn'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            statusMessage: document.getElementById('statusMessage'),
            domainSelect: document.getElementById('domainSelect'),
            categorySelect: document.getElementById('categorySelect'),
            loadQuestionsBtn: document.getElementById('loadQuestionsBtn'),
            domainOverview: document.getElementById('domainOverview'),
            quizForm: document.getElementById('quizForm'),
            quizTitle: document.getElementById('quizTitle'),
            quizTotalQs: document.getElementById('quizTotalQs'),
            questionContainer: document.getElementById('questionContainer'),
            resultsContainer: document.getElementById('resultsContainer'),
            scoreSummary: document.getElementById('scoreSummary'),
            resultsDetails: document.getElementById('resultsDetails')
        };

        // --- Utility Functions ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        // --- API Communication ---

        async function fetchApi(endpoint, method = 'GET', body = null, requiresAuth = true, retryOnAuth = true) {
            const url = API_BASE_URL + endpoint;
            const headers = { 'Content-Type': 'application/json' };

            if (requiresAuth && API_KEY) {
                headers['X-API-Key'] = API_KEY;
            } else if (requiresAuth && !API_KEY) {
                return null;
            }

            try {
                const response = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null, });
                
                if (response.ok) return await response.json();

                const errorData = await response.json().catch(() => ({ detail: 'Unknown API error or malformed JSON response.' }));
                const status = response.status;
                
                if (status === 401 && retryOnAuth) {
                    const newKeyGenerated = await generateKey(true);
                    if (newKeyGenerated) {
                        elements.statusMessage.textContent = `Retrying request with new key...`;
                        return await fetchApi(endpoint, method, body, requiresAuth, false); 
                    }
                    return null;
                } else if (status === 404) {
                    elements.statusMessage.textContent = `API Error (404): Resource not found for ${endpoint}. Check server logs.`;
                } else {
                    elements.statusMessage.textContent = `API Error (${status}): ${errorData.detail || 'Service returned an error.'}`;
                }
                elements.statusMessage.classList.remove('hidden');
                return null;
            } catch (e) {
                console.error("API Fetch Error:", e);
                elements.statusMessage.textContent = `Connection Error: Cannot reach API at ${API_BASE_URL}. Ensure server is running. (Error: ${e.message})`;
                elements.statusMessage.classList.remove('hidden');
                return null;
            }
        }

        async function generateKey(silent = false) {
            const user = "AutoQuizUser01"; 
            if (!silent) {
                 elements.domainOverview.innerHTML = `<p class="text-center text-yellow-400"><span class="pulse-animation">Authenticating...</span></p>`;
            }

            const data = await fetchApi(`/generate-key/?user=${user}`, 'POST', null, false, false); 

            if (data && data.api_key) {
                API_KEY = data.api_key;
                
                // Update new auth UI status
                elements.apiKeyStatus.textContent = '✅ Authenticated';
                elements.apiKeyStatus.classList.remove('text-yellow-400');
                elements.apiKeyStatus.classList.add('text-green-400');
                elements.authBtn.textContent = 'Auto-Authenticated';
                elements.authBtn.classList.add('bg-green-700');
                
                if (!silent) {
                    elements.domainOverview.innerHTML = `<p class="text-center text-green-400">Authentication successful. Loading quiz data...</p>`;
                }
                elements.statusMessage.classList.add('hidden');
                return true; 
            } else {
                elements.domainOverview.innerHTML = `<p class="text-center text-red-400">CRITICAL: Failed to connect to API and generate key.</p>`;
                elements.apiKeyStatus.textContent = '❌ Failed';
                elements.apiKeyStatus.classList.add('text-red-400');
                return false; 
            }
        }

        async function loadDomains() {
            elements.domainOverview.innerHTML = '<p class="text-center"><span class="pulse-animation">Fetching domain list...</span></p>';
            elements.statusMessage.classList.add('hidden');
            let data = null;
            let attempts = 0;
            const maxAttempts = 3;

            while (data === null && attempts < maxAttempts) {
                attempts++;
                data = await fetchApi('/domains/', 'GET', null, true, false); 

                if (data === null) {
                    elements.domainOverview.innerHTML = `<p class="text-center text-yellow-400">Server stabilizing... Retrying domain fetch (Attempt ${attempts}/${maxAttempts})...</p>`;
                    if (attempts < maxAttempts) {
                        await delay(3000); 
                    }
                }
            }

            if (data) {
                // Filter out the DBMS domain before populating the dropdown
                const filteredDomains = {};
                for (const domainKey in data) {
                    if (domainKey !== 'DBMS') {
                        filteredDomains[domainKey] = data[domainKey];
                    }
                }

                currentDomains = filteredDomains;
                populateDomainSelect(filteredDomains);
                elements.domainOverview.textContent = "Domains loaded successfully. Select a quiz category above.";
            } else {
                elements.domainOverview.textContent = "Failed to load domain list after multiple attempts. Is the API server running and accessible?";
            }
        }

        // --- UI Logic ---

        function populateDomainSelect(data) {
            elements.domainSelect.innerHTML = '<option value="">-- Select Domain --</option>';
            for (const domain in data) {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                elements.domainSelect.appendChild(option);
            }
            elements.domainSelect.disabled = false;
        }
        
        function handleDomainChange() {
            const domain = elements.domainSelect.value;
            elements.categorySelect.innerHTML = '<option value="">-- Select Difficulty --</option>';
            elements.categorySelect.disabled = true;
            elements.loadQuestionsBtn.disabled = true;

            if (domain && currentDomains[domain]) {
                const categories = currentDomains[domain];
                for (const category in categories) {
                    const maxQs = MAX_QUESTIONS[category] || categories[category];
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = `${category.charAt(0).toUpperCase() + category.slice(1)} ( ${maxQs} Qs)`;
                    elements.categorySelect.appendChild(option);
                }
                elements.categorySelect.disabled = false;
            }
        }
        
        function handleCategoryChange() {
            elements.loadQuestionsBtn.disabled = !(elements.domainSelect.value && elements.categorySelect.value && API_KEY);
        }

        // --- Loading and Rendering Quiz ---

        async function loadQuestions() {
            elements.statusMessage.classList.add('hidden');
            let domain = elements.domainSelect.value; 
            const category = elements.categorySelect.value;
            const maxQs = MAX_QUESTIONS[category];

            if (!domain || !category) {
                elements.statusMessage.textContent = "Please select both a Domain and a Difficulty.";
                elements.statusMessage.classList.remove('hidden');
                return;
            }
            
            // CRITICAL FIX: Ensure the domain casing matches the Python dictionary key for the request URL
            // This is done to prevent the 404 error caused by case-sensitive Python dictionary lookup
            if (domain.toUpperCase() === "DBMS" || domain.toLowerCase() === "c++") {
                domain = domain.toUpperCase() === "DBMS" ? "DBMS" : "C++";
            } else {
                // For other domains (Python, Java, C, Cloud) which are capitalized in API structure:
                domain = domain.charAt(0).toUpperCase() + domain.slice(1).toLowerCase();
            }
            
            elements.questionContainer.innerHTML = `<p class="text-center"><span class="pulse-animation">Fetching questions for ${domain}/${category}...</span></p>`;
            elements.loadQuestionsBtn.disabled = true;

            let data = null;
            let attempts = 0;
            const maxAttempts = 3;

            while (data === null && attempts < maxAttempts) {
                attempts++;
                data = await fetchApi(`/get-questions/${domain}/${category}`, 'GET', null, true, false); 

                if (data === null) {
                    elements.questionContainer.innerHTML = `<p class="text-center text-yellow-400">Server stabilizing... Retrying quiz fetch (Attempt ${attempts}/${maxAttempts})...</p>`;
                    if (attempts < maxAttempts) {
                        await delay(3000); 
                    }
                }
            }


            if (data && data.questions) {
                shuffleArray(data.questions);

                activeQuestions = data.questions.slice(0, maxQs);
                activeQuizType = data.type;

                renderQuiz(domain, category, activeQuestions, activeQuizType);
            } else if (data) {
                 elements.questionContainer.innerHTML = '<p class="text-red-400">Received data but no questions found.</p>';
            } else {
                 elements.questionContainer.innerHTML = `<p class="text-red-400">Failed to load quiz after ${maxAttempts} attempts. The selected quiz might not exist on the server.</p>`;
            }

            elements.loadQuestionsBtn.disabled = false;
        }

        function renderQuiz(domain, category, questions, type) {
            elements.resultsContainer.classList.add('hidden');
            elements.quizForm.classList.remove('hidden');
            elements.quizTitle.textContent = `${domain} / ${category.toUpperCase()} (${type})`;
            elements.quizTotalQs.textContent = questions.length;
            elements.domainOverview.classList.add('hidden'); // Hide status message while quiz is active

            let html = '';

            questions.forEach((q, index) => {
                const qNum = index + 1;
                html += `<div class="p-4 card rounded-lg shadow-md">`;
                
                if (type === "MCQ") {
                    const questionText = q.question || q;
                    const currentOptions = q.options || [];

                    html += `<p class="font-semibold text-base mb-2">Q${qNum}: ${questionText.trim()}</p>`;
                    
                    html += '<ul class="list-none ml-4 space-y-2 mt-3 text-gray-300">';
                    currentOptions.forEach((option, optIndex) => {
                        const optionLetter = String.fromCharCode(97 + optIndex);
                        
                        html += `<li>
                                    <label class="inline-flex items-center space-x-2">
                                        <input type="radio" 
                                               name="question_${index}" 
                                               value="${option.trim()}" 
                                               data-option-letter="${optionLetter}"
                                               class="form-radio h-4 w-4 text-green-600 bg-gray-600 border-gray-500 focus:ring-green-500">
                                        <span>(${optionLetter}) ${option}</span>
                                    </label>
                                </li>`;
                    });
                    html += '</ul>';

                } else {
                    // Handle Descriptive format
                    const questionText = q.question || q;
                    html += `<p class="font-semibold text-base mb-2">Q${qNum}: ${questionText.trim()}</p>`;
                    html += `<textarea name="question_${index}" 
                                       rows="4" 
                                       placeholder="Type your detailed answer here..." 
                                       class="mt-2 w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"></textarea>`;
                }
                
                html += `</div>`;
            });

            elements.questionContainer.innerHTML = html;
        }


        // --- Submission and Scoring ---

        function submitQuiz() {
            const form = document.getElementById('quizForm');
            const formData = new FormData(form);
            let score = 0;
            const totalPossibleScore = activeQuestions.length;
            let resultsHtml = '';
            
            elements.quizForm.classList.add('hidden');
            elements.resultsContainer.classList.remove('hidden');
            elements.resultsDetails.innerHTML = '';
            
            activeQuestions.forEach((q, index) => {
                let isCorrect = false;
                const qNum = index + 1;
                const questionName = `question_${index}`;
                
                let userAnswer = formData.get(questionName) || "";
                const originalAnswer = (q.answer || "").toString().trim();
                const questionText = (q.question || q).toString(); 

                if (activeQuizType === "MCQ") {
                    userAnswer = userAnswer.trim();
                    // Direct string comparison for MCQ answers
                    isCorrect = (userAnswer.toLowerCase() === originalAnswer.toLowerCase());

                } else {
                    // Descriptive: Simple length check for giving credit
                    userAnswer = userAnswer.trim();
                    isCorrect = userAnswer.length > 5;
                }
                
                if (isCorrect) {
                    score += 1;
                }
                
                // --- Results Rendering ---

                const cardClass = isCorrect ? 'result-correct' : 'result-incorrect';
                const icon = isCorrect ? '✅ Correct' : '❌ Incorrect / Partial Credit';
                const iconColor = isCorrect ? 'text-green-400' : 'text-red-400';
                
                resultsHtml += `<div class="p-4 card rounded-lg shadow-md ${cardClass}">
                                    <p class="font-bold text-lg ${iconColor}">${icon} (Q${qNum})</p>
                                    <p class="font-semibold text-base mt-2">${questionText.trim()}</p>
                                    
                                    <div class="mt-4 p-3 bg-gray-800 rounded-lg text-sm space-y-2">
                                        <p class="font-bold text-gray-400">Your Answer:</p>
                                        <pre class="whitespace-pre-wrap text-white">${userAnswer || 'N/A'}</pre>
                                    </div>

                                    <div class="mt-2 p-3 bg-gray-800 rounded-lg text-sm space-y-2">
                                        <p class="font-bold text-green-400">Correct Answer:</p>
                                        <pre class="whitespace-pre-wrap text-green-300">${originalAnswer}</pre>
                                    </div>
                                </div>`;
            });
            
            // Update Summary
            elements.resultsDetails.innerHTML = resultsHtml;
            elements.scoreSummary.innerHTML = `You scored: <span class="text-yellow-400">${score}</span> out of <span class="text-yellow-400">${totalPossibleScore}</span>.`;
            if (activeQuizType !== "MCQ") {
                elements.scoreSummary.innerHTML += `<p class="text-sm text-gray-400 mt-2">*(For descriptive, credit was given if your answer was more than 5 characters long.)</p>`;
            }

            elements.resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }


        // --- Initialization ---

        async function init() {
            // Initiate the key generation process immediately and silently
            const keyGenerated = await generateKey();
            if (keyGenerated) {
                // Only proceed to load domains if key generation was successful
                await loadDomains();
            }

            // Event Listeners
            elements.domainSelect.addEventListener('change', handleDomainChange);
            elements.categorySelect.addEventListener('change', handleCategoryChange);
        }

        window.onload = init;
    </script>
</body>
</html>



