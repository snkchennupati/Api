<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Quiz Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .container {
            max-width: 1000px;
        }
        .card {
            background-color: #161b22; /* Slightly lighter card background */
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .btn {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .mcq-answer-correct {
            color: #38a169; /* Green text for correct answer */
            font-weight: 600;
        }
        .pulse-animation {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .skeleton-line {
            background-color: #30363d;
            height: 1.5rem;
            border-radius: 0.25rem;
            animation: loading-pulse 1.5s infinite;
        }
        @keyframes loading-pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .result-correct {
            border-left: 4px solid #38a169;
        }
        .result-incorrect {
            border-left: 4px solid #e53e3e;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-200">

    <div class="container mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-green-400 border-b border-gray-700 pb-3">Technical Quiz Portal</h1>

        <!-- API Key Management -->
        <div class="card p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-green-300">1. API Key Setup</h2>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <input type="text" id="userId" placeholder="Enter User ID (e.g., JaneDoe)" class="p-3 rounded-lg flex-grow bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="generateKey()" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg">
                    Get/Refresh API Key
                </button>
            </div>
            <div id="apiKeyDisplay" class="mt-4 p-3 bg-gray-800 rounded-lg text-sm break-all">
                API Key: <span id="apiKeyStatus" class="text-red-400">Not set. Please generate a key.</span>
            </div>
            <div id="statusMessage" class="mt-3 text-sm text-red-400 hidden"></div>
        </div>

        <!-- Domain Selection and Fetch -->
        <div class="card p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-green-300">2. Select Quiz</h2>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
                <select id="domainSelect" class="p-3 rounded-lg flex-grow bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="">-- Select Domain --</option>
                    <!-- Options populated by JS -->
                </select>
                <select id="categorySelect" class="p-3 rounded-lg flex-grow bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" disabled>
                    <option value="">-- Select Difficulty --</option>
                    <!-- Options populated by JS -->
                </select>
                <button onclick="loadQuestions()" id="loadQuestionsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50">
                    Load Quiz
                </button>
            </div>
            <div id="domainOverview" class="mt-4 p-3 bg-gray-800 rounded-lg text-sm">
                Domain Overview: Loading...
            </div>
        </div>

        <!-- Quiz Area -->
        <form id="quizForm" class="card p-6 rounded-lg hidden">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h2 class="text-2xl font-semibold text-green-300">3. Active Quiz: <span id="quizTitle"></span></h2>
                <span class="text-xl font-bold text-gray-400">Total Qs: <span id="quizTotalQs"></span></span>
            </div>
            
            <div id="questionContainer" class="space-y-6">
                <!-- Questions populated here -->
            </div>

            <button type="button" onclick="submitQuiz()" id="submitQuizBtn" class="mt-8 w-full btn bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg">
                Submit Quiz and View Score
            </button>
        </form>

        <!-- Results Area -->
        <div id="resultsContainer" class="card p-6 rounded-lg mt-8 hidden">
            <h2 class="text-2xl font-semibold text-yellow-400 mb-4 border-b border-gray-700 pb-3">Quiz Results</h2>
            <div id="scoreSummary" class="text-lg font-bold mb-4"></div>
            <button onclick="window.location.reload()" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">
                Start New Quiz
            </button>
            <div id="resultsDetails" class="space-y-6 mt-6">
                <!-- Detailed results populated here -->
            </div>
        </div>

    </div>

    <script>
        // Set the API URL to your live Render deployment
        const API_BASE_URL = 'https://fast-quiz-api.onrender.com';
        
        let API_KEY = sessionStorage.getItem('quizApiKey') || '';
        let currentDomains = {};
        let activeQuestions = [];
        let activeQuizType = "";
        const MAX_QUESTIONS = { easy: 20, medium: 10, hard: 5 };

        const elements = {
            userId: document.getElementById('userId'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            statusMessage: document.getElementById('statusMessage'),
            domainSelect: document.getElementById('domainSelect'),
            categorySelect: document.getElementById('categorySelect'),
            loadQuestionsBtn: document.getElementById('loadQuestionsBtn'),
            domainOverview: document.getElementById('domainOverview'),
            quizForm: document.getElementById('quizForm'),
            quizTitle: document.getElementById('quizTitle'),
            quizTotalQs: document.getElementById('quizTotalQs'),
            questionContainer: document.getElementById('questionContainer'),
            resultsContainer: document.getElementById('resultsContainer'),
            scoreSummary: document.getElementById('scoreSummary'),
            resultsDetails: document.getElementById('resultsDetails')
        };

        // --- Utility Functions ---

        /**
         * Shuffles an array (Fisher-Yates algorithm).
         * @param {Array} array 
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * Fetches data from the API with integrated error and auth handling.
         */
        async function fetchApi(endpoint, method = 'GET', body = null, requiresAuth = true) {
            const url = API_BASE_URL + endpoint;
            const headers = { 'Content-Type': 'application/json' };

            if (requiresAuth && API_KEY) {
                headers['X-API-Key'] = API_KEY;
            } else if (requiresAuth && !API_KEY) {
                elements.statusMessage.textContent = "Error: API Key is missing. Please generate a key first.";
                elements.statusMessage.classList.remove('hidden');
                return null;
            }

            try {
                const response = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null, });
                if (response.ok) return await response.json();

                const errorData = await response.json().catch(() => ({ detail: 'Unknown API error or malformed JSON response.' }));
                const status = response.status;
                
                if (status === 401) {
                    elements.statusMessage.textContent = `Authentication Error: Invalid or expired API Key. Please regenerate the key.`;
                    API_KEY = ''; 
                    sessionStorage.removeItem('quizApiKey');
                    updateKeyDisplay();
                } else if (status === 404) {
                     elements.statusMessage.textContent = `API Error (404): Resource not found for ${endpoint}.`;
                } else {
                    elements.statusMessage.textContent = `API Error (${status}): ${errorData.detail || 'Service returned an error.'}`;
                }
                elements.statusMessage.classList.remove('hidden');
                return null;
            } catch (e) {
                console.error("API Fetch Error:", e);
                elements.statusMessage.textContent = `Connection Error: Cannot reach API at ${API_BASE_URL}. Ensure your server is live. (Error: ${e.message})`;
                elements.statusMessage.classList.remove('hidden');
                return null;
            }
        }

        function updateKeyDisplay() {
            if (API_KEY) {
                elements.apiKeyStatus.textContent = API_KEY;
                elements.apiKeyStatus.classList.remove('text-red-400', 'pulse-animation');
                elements.apiKeyStatus.classList.add('text-green-400');
            } else {
                elements.apiKeyStatus.textContent = 'Not set. Please generate a key.';
                elements.apiKeyStatus.classList.add('text-red-400');
                elements.apiKeyStatus.classList.remove('text-green-400');
            }
        }

        // --- Core Application Logic (Auth, Domains, Loading) ---

        async function generateKey() {
            elements.statusMessage.classList.add('hidden');
            const user = elements.userId.value.trim();

            if (!user) {
                elements.statusMessage.textContent = "Please enter a User ID.";
                elements.statusMessage.classList.remove('hidden');
                return;
            }

            elements.apiKeyStatus.innerHTML = '<span class="pulse-animation">Generating...</span>';

            const data = await fetchApi(`/generate-key/?user=${user}`, 'POST', null, false);

            if (data && data.api_key) {
                API_KEY = data.api_key;
                sessionStorage.setItem('quizApiKey', API_KEY);
                updateKeyDisplay();
                elements.statusMessage.textContent = `Success! API Key generated for user: ${data.user}.`;
                elements.statusMessage.classList.remove('hidden', 'text-red-400');
                elements.statusMessage.classList.add('text-green-400');
                await loadDomains();
            } else {
                elements.apiKeyStatus.innerHTML = 'Generation failed.';
            }
        }

        async function loadDomains() {
            elements.domainOverview.innerHTML = '<div class="flex space-x-2"><div class="skeleton-line w-1/3"></div><div class="skeleton-line w-1/4"></div></div>';
            elements.statusMessage.classList.add('hidden');

            const data = await fetchApi('/domains/');

            if (data) {
                currentDomains = data;
                populateDomainSelect(data);
                displayDomainOverview(data);
            } else {
                elements.domainOverview.textContent = "Failed to load domain overview. (Requires API Key)";
            }
        }

        function populateDomainSelect(data) {
            elements.domainSelect.innerHTML = '<option value="">-- Select Domain --</option>';
            for (const domain in data) {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                elements.domainSelect.appendChild(option);
            }
            elements.domainSelect.disabled = false;
        }

        function displayDomainOverview(data) {
            let html = '<table class="w-full text-left">';
            html += '<thead><tr class="text-green-300 border-b border-gray-700"><th>Domain</th><th>Easy (MCQ)</th><th>Medium (Descriptive)</th><th>Hard (Descriptive)</th></tr></thead>';
            html += '<tbody>';
            
            for (const domain in data) {
                const counts = data[domain];
                html += `<tr class="border-b border-gray-700 hover:bg-gray-700/50">
                            <td class="py-2 font-semibold">${domain}</td>
                            <td>${counts.easy || 0}</td>
                            <td>${counts.medium || 0}</td>
                            <td>${counts.hard || 0}</td>
                        </tr>`;
            }

            html += '</tbody></table>';
            elements.domainOverview.innerHTML = html;
        }

        function handleDomainChange() {
            const domain = elements.domainSelect.value;
            elements.categorySelect.innerHTML = '<option value="">-- Select Difficulty --</option>';
            elements.categorySelect.disabled = true;
            elements.loadQuestionsBtn.disabled = true;

            if (domain && currentDomains[domain]) {
                const categories = currentDomains[domain];
                for (const category in categories) {
                    const maxQs = MAX_QUESTIONS[category] || categories[category];
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = `${category.charAt(0).toUpperCase() + category.slice(1)} (Will load ${maxQs} Qs)`;
                    elements.categorySelect.appendChild(option);
                }
                elements.categorySelect.disabled = false;
            }
        }
        
        function handleCategoryChange() {
            elements.loadQuestionsBtn.disabled = !(elements.domainSelect.value && elements.categorySelect.value);
        }

        async function loadQuestions() {
            elements.statusMessage.classList.add('hidden');
            const domain = elements.domainSelect.value;
            const category = elements.categorySelect.value;
            const maxQs = MAX_QUESTIONS[category];

            if (!domain || !category) {
                elements.statusMessage.textContent = "Please select both a Domain and a Difficulty.";
                elements.statusMessage.classList.remove('hidden');
                return;
            }
            
            elements.questionContainer.innerHTML = '<p class="text-center"><span class="pulse-animation">Fetching all questions...</span></p>';
            elements.loadQuestionsBtn.disabled = true;

            const data = await fetchApi(`/get-questions/${domain}/${category}`);

            if (data && data.questions) {
                // 1. Shuffle all questions fetched
                shuffleArray(data.questions);

                // 2. Select the required subset (e.g., 20, 10, or 5)
                activeQuestions = data.questions.slice(0, maxQs);
                activeQuizType = data.type;

                renderQuiz(domain, category, activeQuestions, activeQuizType);
            } else if (data) {
                 elements.questionContainer.innerHTML = '<p class="text-red-400">Received data but no questions found.</p>';
            }

            elements.loadQuestionsBtn.disabled = false;
        }

        // --- Rendering the Quiz (Input Form) ---

        function renderQuiz(domain, category, questions, type) {
            elements.resultsContainer.classList.add('hidden');
            elements.quizForm.classList.remove('hidden');
            elements.quizTitle.textContent = `${domain} / ${category.toUpperCase()} (${type})`;
            elements.quizTotalQs.textContent = questions.length;

            let html = '';

            questions.forEach((q, index) => {
                const qNum = index + 1;
                html += `<div class="p-4 card rounded-lg shadow-md">`;
                
                if (type === "MCQ") {
                    const questionText = q.question || q;
                    // For legacy Python MCQs (string format): extract question and options
                    let currentQuestion = questionText;
                    let currentOptions = q.options || [];
                    let isLegacy = false;

                    if (!q.options && typeof q === 'string') {
                        isLegacy = true;
                        // Regex to split question text from options (a)...(b)...
                        const match = questionText.match(/(.*)\s+\((a)\)/i);
                        if (match) {
                            currentQuestion = match[1].trim();
                            // FIX: Corrected regex for splitting options
                            const optionsString = questionText.substring(match[1].length).trim();
                            currentOptions = optionsString.split(/\s*(?=\([a-d]\))/).map(s => s.trim()).filter(s => s);
                        } else {
                            currentQuestion = questionText;
                        }
                    }

                    html += `<p class="font-semibold text-base mb-2">Q${qNum}: ${currentQuestion.replace('✅', '').trim()}</p>`;
                    
                    html += '<ul class="list-none ml-4 space-y-2 mt-3 text-gray-300">';
                    currentOptions.forEach((option, optIndex) => {
                        const optionValue = option.replace(/^\((.)\)\s*/, '$1').trim();
                        const optionLetter = option.match(/^\((.)\)/) ? option.match(/^\((.)\)/)[1] : String.fromCharCode(97 + optIndex);
                        
                        html += `<li>
                                    <label class="inline-flex items-center space-x-2">
                                        <input type="radio" 
                                               name="question_${index}" 
                                               value="${optionValue}" 
                                               data-option-letter="${optionLetter}"
                                               class="form-radio h-4 w-4 text-green-600 bg-gray-600 border-gray-500 focus:ring-green-500">
                                        <span>${option}</span>
                                    </label>
                                </li>`;
                    });
                    html += '</ul>';

                } else {
                    // Handle Descriptive format
                    html += `<p class="font-semibold text-base mb-2">Q${qNum}: ${q.question}</p>`;
                    html += `<textarea name="question_${index}" 
                                       rows="4" 
                                       placeholder="Type your detailed answer here..." 
                                       class="mt-2 w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"></textarea>`;
                }
                
                html += `</div>`;
            });

            elements.questionContainer.innerHTML = html;
        }


        // --- Submission and Scoring ---

        function submitQuiz() {
            const form = document.getElementById('quizForm');
            const formData = new FormData(form);
            let score = 0;
            let totalPossibleScore = activeQuestions.length;
            let resultsHtml = '';
            
            // Hide the quiz, show the results
            elements.quizForm.classList.add('hidden');
            elements.resultsContainer.classList.remove('hidden');
            elements.resultsDetails.innerHTML = '';
            
            activeQuestions.forEach((q, index) => {
                const qNum = index + 1;
                let isCorrect = false;
                let userAnswer = "";
                let originalAnswer = q.answer || q;
                let questionText = q.question || q;

                const questionName = `question_${index}`;

                if (activeQuizType === "MCQ") {
                    userAnswer = formData.get(questionName) || "No Answer Selected";
                    
                    // Standard MCQ (dict format)
                    if (q.answer) {
                        originalAnswer = q.answer.trim();
                        isCorrect = (userAnswer.toLowerCase() === originalAnswer.toLowerCase());
                    } else if (typeof q === 'string') {
                        // Legacy Python MCQ (string format with ✅)
                        const match = q.match(/\((.)\)\s*(.*?) ✅/);
                        if (match) {
                            originalAnswer = match[2].trim(); // The answer text
                            const selectedElement = document.querySelector(`input[name="${questionName}"]:checked`);
                            if(selectedElement) {
                                // Compare the option letter or the option text
                                const selectedOptionLetter = selectedElement.dataset.optionLetter;
                                const answerLetterMatch = q.match(/\((.)\) .*? ✅/);

                                if (answerLetterMatch) {
                                    const correctLetter = answerLetterMatch[1].toLowerCase();
                                    isCorrect = (selectedOptionLetter.toLowerCase() === correctLetter);
                                }
                                // Fallback: compare the selected text
                                if (!isCorrect) {
                                     isCorrect = (userAnswer.toLowerCase() === originalAnswer.toLowerCase());
                                }
                            }
                        }
                    }

                } else {
                    // Descriptive Type (medium/hard)
                    userAnswer = formData.get(questionName).trim();
                    originalAnswer = q.answer.trim();
                    
                    // Simple credit logic for descriptive (for this exercise, assume correct if answer is not empty)
                    isCorrect = userAnswer.length > 5; // Placeholder for subjective scoring

                    if (isCorrect) {
                        // Descriptive questions are given credit if they show effort
                        score += 1;
                    }
                    totalPossibleScore = activeQuestions.length; // Max score equals number of questions
                }

                if (isCorrect && activeQuizType === "MCQ") {
                    score += 1;
                }
                
                // --- Results Rendering ---

                const cardClass = isCorrect ? 'result-correct' : 'result-incorrect';
                const icon = isCorrect ? '✅ Correct' : '❌ Incorrect / Partial Credit';
                const iconColor = isCorrect ? 'text-green-400' : 'text-red-440';
                
                resultsHtml += `<div class="p-4 card rounded-lg shadow-md ${cardClass}">
                                    <p class="font-bold text-lg ${iconColor}">${icon} (Q${qNum})</p>
                                    <p class="font-semibold text-base mt-2">${questionText.replace('✅', '').trim()}</p>
                                    
                                    <div class="mt-4 p-3 bg-gray-800 rounded-lg text-sm space-y-2">
                                        <p class="font-bold text-gray-400">Your Answer:</p>
                                        <pre class="whitespace-pre-wrap text-white">${userAnswer || 'N/A'}</pre>
                                    </div>

                                    <div class="mt-2 p-3 bg-gray-800 rounded-lg text-sm space-y-2">
                                        <p class="font-bold text-green-400">Original Answer:</p>
                                        <pre class="whitespace-pre-wrap">${originalAnswer}</pre>
                                    </div>
                                </div>`;
            });
            
            // Update Summary
            elements.resultsDetails.innerHTML = resultsHtml;
            elements.scoreSummary.innerHTML = `You scored: <span class="text-yellow-400">${score}</span> out of <span class="text-yellow-400">${totalPossibleScore}</span>.`;
            elements.scoreSummary.innerHTML += `<p class="text-sm text-gray-400 mt-2">*(For Descriptive questions, credit is given if your answer is greater than 5 characters long.)</p>`;

            // Scroll to top of results
            elements.resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }


        // --- Initialization ---

        function init() {
            // Check for existing API Key
            if (API_KEY) {
                updateKeyDisplay();
                loadDomains();
                elements.userId.value = "Session User"; // Placeholder to indicate key is set
            } else {
                // If no key exists, only update the display, wait for user to generate key
                updateKeyDisplay();
                loadDomains(); 
            }

            // Event Listeners
            elements.domainSelect.addEventListener('change', handleDomainChange);
            elements.categorySelect.addEventListener('change', handleCategoryChange);
        }

        window.onload = init;
    </script>
</body>
</html>
